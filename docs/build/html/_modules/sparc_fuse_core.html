

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sparc_fuse_core &mdash; SPARC FUSE  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            SPARC FUSE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SPARC FUSE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">sparc_fuse_core</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sparc_fuse_core</h1><div class="highlight"><pre>
<span></span><span class="c1"># ── standard library ────────────────────────────────────────────────────────</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span> 
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">quote</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>

<span class="c1"># ── third-party ─────────────────────────────────────────────────────────────</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">imageio.v3</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">iio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tifffile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nd2reader</span><span class="w"> </span><span class="kn">import</span> <span class="n">ND2Reader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">packaging.version</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse</span> <span class="k">as</span> <span class="n">vparse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">s3fs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># ── project-specific / local ────────────────────────────────────────────────</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">load_all_descriptors</span><span class="p">,</span>
    <span class="n">match_best_mapping</span><span class="p">,</span>
    <span class="n">save_standardized_output</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sparc.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">SparcClient</span>


<span class="n">client</span> <span class="o">=</span> <span class="n">SparcClient</span><span class="p">(</span><span class="n">connect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">config_file</span><span class="o">=</span><span class="s1">&#39;config.ini&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="fetch_dataset_metadata">
<a class="viewcode-back" href="../api.html#sparc_fuse_core.fetch_dataset_metadata">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_dataset_metadata</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches metadata for a specified dataset from the Pennsieve Discover API.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        dataset_id (str or int): The unique identifier of the dataset to fetch metadata for.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: The metadata of the specified dataset as returned by the API.</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        requests.HTTPError: If the HTTP request to the API fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metadata_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.pennsieve.io/discover/datasets/</span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">/versions/1/metadata&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata_url</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>


<div class="viewcode-block" id="list_primary_files">
<a class="viewcode-back" href="../api.html#sparc_fuse_core.list_primary_files">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_primary_files</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve primary files from a dataset&#39;s metadata.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        dataset_id (str): The unique identifier of the dataset.</span>
<span class="sd">   </span>
<span class="sd">     Returns:</span>
<span class="sd">        tuple: A tuple containing:</span>
<span class="sd">            - primary_files (list): A list of file dictionaries whose paths start with &quot;files/primary/&quot;.</span>
<span class="sd">            - metadata (dict): The complete metadata dictionary for the dataset.</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        Any exceptions raised by fetch_dataset_metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">fetch_dataset_metadata</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>
    <span class="n">primary_files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;files/primary/&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">primary_files</span><span class="p">,</span> <span class="n">metadata</span></div>


<div class="viewcode-block" id="print_project_metadata">
<a class="viewcode-back" href="../api.html#sparc_fuse_core.print_project_metadata">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_project_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints the &#39;item&#39; field from the provided metadata dictionary in a formatted JSON structure.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        metadata (dict): A dictionary containing project metadata. Expected to have an &#39;item&#39; key.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span></div>


<div class="viewcode-block" id="download_and_move_sparc_file">
<a class="viewcode-back" href="../api.html#sparc_fuse_core.download_and_move_sparc_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">download_and_move_sparc_file</span><span class="p">(</span><span class="n">rel_path</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Downloads a file from a SPARC dataset using the provided relative path and dataset ID,</span>
<span class="sd">    then moves the downloaded file to the specified output directory.</span>

<span class="sd">    The function ensures the relative path starts with &#39;primary/&#39;, constructs the appropriate</span>
<span class="sd">    query path for the SPARC API, and handles file download and movement. If the file is not</span>
<span class="sd">    found or an error occurs during download or movement, an error message is printed.</span>

<span class="sd">    Args:</span>
<span class="sd">        rel_path (str): The relative path to the file within the SPARC dataset.</span>
<span class="sd">        dataset_id (str): The identifier of the SPARC dataset to download from.</span>
<span class="sd">        output_dir (str): The directory where the downloaded file should be moved.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If no matching file is found in the SPARC dataset.</span>
<span class="sd">        Exception: For any other errors encountered during download or file movement.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rel_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;primary/&quot;</span><span class="p">):</span>
        <span class="n">rel_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;primary/</span><span class="si">{</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># SPARC expects &#39;files/primary/...&#39;</span>
    <span class="n">query_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;files/</span><span class="si">{</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">local_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Downloading </span><span class="si">{</span><span class="n">rel_path</span><span class="si">}</span><span class="s2"> from SPARC dataset </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">pennsieve</span><span class="o">.</span><span class="n">list_files</span><span class="p">(</span><span class="n">dataset_id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No matching file for </span><span class="si">{</span><span class="n">query_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">pennsieve</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">file_list</span><span class="o">=</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Download result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Move file to output directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">src_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">local_filename</span><span class="p">)</span>
        <span class="n">dest_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">local_filename</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Moved file to: </span><span class="si">{</span><span class="n">dest_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: your actual file conversion logic goes here</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] Could not download or move file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="list_sparc_datasets">
<a class="viewcode-back" href="../api.html#sparc_fuse_core.list_sparc_datasets">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_sparc_datasets</span><span class="p">(</span><span class="n">max_id</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves and categorizes SPARC datasets by their type.</span>

<span class="sd">    This function queries the metadata client for datasets with IDs in the range 0 to `max_id` (inclusive),</span>
<span class="sd">    then counts and groups the datasets by their type name. It prints the response and a summary of dataset</span>
<span class="sd">    type counts.</span>

<span class="sd">    Args:</span>
<span class="sd">        max_id (int, optional): The maximum dataset ID to include in the query. Defaults to 1000.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A mapping from dataset type names to lists of dataset IDs belonging to each type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1001</span><span class="p">))</span>
    <span class="n">id_strings</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
    <span class="n">id_list_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">id_strings</span><span class="p">)</span>

    <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    </span><span class="se">{{</span>
<span class="s1">    &quot;size&quot;: </span><span class="si">{</span><span class="n">max_id</span><span class="si">}</span><span class="s1">,</span>
<span class="s1">    &quot;query&quot;: </span><span class="se">{{</span>
<span class="s1">        &quot;terms&quot;: </span><span class="se">{{</span>
<span class="s1">        &quot;_id&quot;: [ </span><span class="si">{</span><span class="n">id_list_str</span><span class="si">}</span><span class="s1"> ]</span>
<span class="s1">        </span><span class="se">}}</span>
<span class="s1">    </span><span class="se">}}</span>
<span class="s1">    </span><span class="se">}}</span>
<span class="s1">    &#39;&#39;&#39;</span>
    <span class="n">body_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">search_datasets</span><span class="p">(</span><span class="n">body_json</span><span class="p">)</span>
    <span class="n">type_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
    <span class="n">type_id_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;response: &quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">][</span><span class="s2">&quot;hits&quot;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;_source&quot;</span><span class="p">][</span><span class="s2">&quot;item&quot;</span><span class="p">][</span><span class="s2">&quot;types&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="s2">&quot;&lt;invalid type&gt;&quot;</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;no id&gt;&quot;</span><span class="p">)</span>
        <span class="n">type_counter</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">type_id_map</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataset type counts:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">type_counter</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">type_id_map</span></div>


<div class="viewcode-block" id="get_sparc_datasets_by_id">
<a class="viewcode-back" href="../api.html#sparc_fuse_core.get_sparc_datasets_by_id">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_sparc_datasets_by_id</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve SPARC datasets from the metadata client by their IDs and group them by type.</span>

<span class="sd">    Args:</span>
<span class="sd">        ids (int, list, tuple, or set): A single dataset ID or a collection of dataset IDs to query.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary mapping dataset type names to lists of dataset IDs that belong to each type.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the input is not an int, list, tuple, or set.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - The function prints the constructed query and the response for debugging purposes.</span>
<span class="sd">        - If a dataset does not have a valid type, it is grouped under the key &quot;&lt;invalid type&gt;&quot;.</span>
<span class="sd">        - If a dataset does not have an ID, it is represented as &quot;&lt;no id&gt;&quot; in the result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Normalize to list</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input must be an int or a list/tuple/set of ints&quot;</span><span class="p">)</span>

    <span class="c1"># Build query</span>
    <span class="n">id_strings</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
    <span class="n">id_list_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">id_strings</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    </span><span class="se">{{</span>
<span class="s1">      &quot;size&quot;: 1000,</span>
<span class="s1">      &quot;query&quot;: </span><span class="se">{{</span>
<span class="s1">        &quot;terms&quot;: </span><span class="se">{{</span>
<span class="s1">          &quot;_id&quot;: [ </span><span class="si">{</span><span class="n">id_list_str</span><span class="si">}</span><span class="s1"> ]</span>
<span class="s1">        </span><span class="se">}}</span>
<span class="s1">      </span><span class="se">}}</span>
<span class="s1">    </span><span class="se">}}</span>
<span class="s1">    &#39;&#39;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Query:&quot;</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="c1"># Submit search</span>
    <span class="n">body_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">search_datasets</span><span class="p">(</span><span class="n">body_json</span><span class="p">)</span>
    <span class="n">type_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
    <span class="n">type_id_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Response:&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">][</span><span class="s2">&quot;hits&quot;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;_source&quot;</span><span class="p">][</span><span class="s2">&quot;item&quot;</span><span class="p">][</span><span class="s2">&quot;types&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="s2">&quot;&lt;invalid type&gt;&quot;</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;no id&gt;&quot;</span><span class="p">)</span>
        <span class="n">type_counter</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">type_id_map</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">type_id_map</span></div>


<span class="c1"># -------------------------------------------------------------------------</span>
<span class="c1"># 1. decide default OME-Zarr version (zarr&lt;3 → v0.4, else v0.5)</span>
<span class="c1"># -------------------------------------------------------------------------</span>
<span class="n">_ZARR_GE_3</span> <span class="o">=</span> <span class="n">vparse</span><span class="p">(</span><span class="n">zarr</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">vparse</span><span class="p">(</span><span class="s2">&quot;3.0.0b2&quot;</span><span class="p">)</span>
<span class="n">_DEFAULT_OZ_VER</span> <span class="o">=</span> <span class="s2">&quot;0.5&quot;</span> <span class="k">if</span> <span class="n">_ZARR_GE_3</span> <span class="k">else</span> <span class="s2">&quot;0.4&quot;</span>

<span class="c1"># -------------------------------------------------------------------------</span>
<span class="c1"># 2. sets of extensions that need special treatment</span>
<span class="c1"># -------------------------------------------------------------------------</span>
<span class="n">IMAGING_EXTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;.czi&quot;</span><span class="p">,</span> <span class="s2">&quot;.nd2&quot;</span><span class="p">,</span> <span class="s2">&quot;.lsm&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpx&quot;</span><span class="p">,</span> <span class="s2">&quot;.svs&quot;</span><span class="p">,</span> <span class="s2">&quot;.ims&quot;</span><span class="p">,</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;.bmp&quot;</span><span class="p">,</span> <span class="s2">&quot;.vsi&quot;</span><span class="p">,</span> <span class="s2">&quot;.jp2&quot;</span><span class="p">,</span> <span class="s2">&quot;.roi&quot;</span><span class="p">,</span> <span class="s2">&quot;.dm3&quot;</span><span class="p">,</span> <span class="s2">&quot;.pxp&quot;</span><span class="p">,</span> <span class="s2">&quot;.ipf&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.lif&quot;</span><span class="p">,</span> <span class="s2">&quot;.ima&quot;</span><span class="p">,</span> <span class="s2">&quot;.mrxs&quot;</span><span class="p">,</span> <span class="s2">&quot;.obj&quot;</span><span class="p">,</span> <span class="s2">&quot;.avi&quot;</span><span class="p">,</span> <span class="s2">&quot;.exf&quot;</span><span class="p">,</span> <span class="s2">&quot;.cxd&quot;</span>
<span class="p">}</span>


<span class="n">_RGB_EXTS</span>      <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="s2">&quot;.bmp&quot;</span><span class="p">}</span>
<span class="n">_BF_EXTS</span>       <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;.jpx&quot;</span><span class="p">,</span> <span class="s2">&quot;.jp2&quot;</span><span class="p">,</span> <span class="s2">&quot;.svs&quot;</span><span class="p">,</span> <span class="s2">&quot;.ims&quot;</span><span class="p">,</span> <span class="s2">&quot;.czi&quot;</span><span class="p">,</span> <span class="s2">&quot;.vsi&quot;</span><span class="p">,</span> <span class="s2">&quot;.mrxs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.obj&quot;</span><span class="p">,</span> <span class="s2">&quot;.exf&quot;</span><span class="p">,</span> <span class="s2">&quot;.cxd&quot;</span><span class="p">,</span> <span class="s2">&quot;.ima&quot;</span><span class="p">,</span> <span class="s2">&quot;.dm3&quot;</span><span class="p">,</span> <span class="s2">&quot;.pxp&quot;</span><span class="p">,</span> <span class="s2">&quot;.ipf&quot;</span><span class="p">,</span> <span class="s2">&quot;.roi&quot;</span><span class="p">,</span> <span class="s2">&quot;.lsm&quot;</span>
<span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    (subprocess.run with nice error surfacing) --&gt; Executes a command using subprocess.run and raises a RuntimeError with detailed output if the command fails.</span>

<span class="sd">    Args:</span>
<span class="sd">        cmd (list[str]): The command and its arguments to execute as a list of strings.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If the command returns a non-zero exit code, includes the command, stdout, and stderr in the error message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Command failed (</span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">STDOUT:</span><span class="se">\n</span><span class="si">{</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="si">}</span><span class="se">\n</span><span class="s2">STDERR:</span><span class="se">\n</span><span class="si">{</span><span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

<span class="c1"># -------------------------------------------------------------------------</span>
<span class="c1"># 3. main helper</span>
<span class="c1"># -------------------------------------------------------------------------</span>
<div class="viewcode-block" id="convert_imaging_file">
<a class="viewcode-back" href="../api.html#sparc_fuse_core.convert_imaging_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_imaging_file</span><span class="p">(</span>
    <span class="n">local_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">ome_zarr_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;dask_image_gaussian&quot;</span><span class="p">,</span>
    <span class="n">output_scale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts *local_path* to an OME-Zarr store and returns its Path.</span>

<span class="sd">    * RGB images (.jpg/.png/…) are re-packed to channel-first OME-TIFF.</span>
<span class="sd">    * ND2 is converted with nd2reader.</span>
<span class="sd">    * LIF + a long list of bio-formats-compatible slide formats go through</span>
<span class="sd">      `bfconvert`.</span>
<span class="sd">    * Plain TIFFs are sent directly to ngff-zarr.</span>
<span class="sd">    * Everything else is attempted “as is” (ngff-zarr can open many types).</span>

<span class="sd">    Parameters:</span>
<span class="sd">        local_path (Path): Path to the input imaging file.</span>
<span class="sd">        output_dir (Path): Directory where the OME-Zarr store will be created.</span>
<span class="sd">        ome_zarr_version (str | None, optional): OME-Zarr version to use. Defaults to a module-level default if None.</span>
<span class="sd">        method (str, optional): Downsampling method for ngff-zarr. Defaults to &quot;dask_image_gaussian&quot;.</span>
<span class="sd">        output_scale (str, optional): Output scale for ngff-zarr. Defaults to &quot;3&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path: Path to the generated OME-Zarr store.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If an RGB image does not have the expected shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ome_zarr_version</span> <span class="o">=</span> <span class="n">ome_zarr_version</span> <span class="ow">or</span> <span class="n">_DEFAULT_OZ_VER</span>
    <span class="n">ext</span>     <span class="o">=</span> <span class="n">local_path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">tmp_tif</span> <span class="o">=</span> <span class="kc">None</span>                       <span class="c1"># will hold any intermediate TIFF</span>

    <span class="c1"># ---------- A. convert to (OME)-TIFF if needed -------------------------</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">}:</span>
        <span class="n">tif_path</span> <span class="o">=</span> <span class="n">local_path</span>

    <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.nd2&quot;</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">ND2Reader</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">local_path</span><span class="p">))</span> <span class="k">as</span> <span class="n">nd2</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">img</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">nd2</span><span class="p">])</span>
                   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nd2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">nd2</span><span class="o">.</span><span class="n">get_frame_2D</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">tmp_tif</span> <span class="o">=</span> <span class="n">local_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.ome.tif&quot;</span><span class="p">)</span>
        <span class="n">iio</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">tmp_tif</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">))</span>
        <span class="n">tif_path</span> <span class="o">=</span> <span class="n">tmp_tif</span>

    <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">_RGB_EXTS</span><span class="p">:</span>
        <span class="c1"># RGB → channel-first, then write real TIFF</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">iio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected HxWxC RGB/RGBA image, got shape </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">img_cyx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>           <span class="c1"># (C, Y, X)</span>
        <span class="n">tmp_tif</span> <span class="o">=</span> <span class="n">local_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.ome.tif&quot;</span><span class="p">)</span>
        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">tmp_tif</span><span class="p">,</span> <span class="n">img_cyx</span><span class="p">,</span> <span class="n">photometric</span><span class="o">=</span><span class="s2">&quot;rgb&quot;</span><span class="p">)</span>
        <span class="n">tif_path</span> <span class="o">=</span> <span class="n">tmp_tif</span>

    <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.lif&quot;</span> <span class="ow">or</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">_BF_EXTS</span><span class="p">:</span>
        <span class="n">tmp_tif</span> <span class="o">=</span> <span class="n">local_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.ome.tif&quot;</span><span class="p">)</span>
        <span class="n">_run</span><span class="p">([</span><span class="s2">&quot;bfconvert&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">local_path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">tmp_tif</span><span class="p">)])</span>
        <span class="n">tif_path</span> <span class="o">=</span> <span class="n">tmp_tif</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># hope ngff-zarr can open it directly</span>
        <span class="n">tif_path</span> <span class="o">=</span> <span class="n">local_path</span>

    <span class="c1"># ---------- B. run ngff-zarr ------------------------------------------</span>
    <span class="n">zarr_out</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tif_path</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">.ome.zarr&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;ngff-zarr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tif_path</span><span class="p">),</span>
        <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">zarr_out</span><span class="p">),</span>
        <span class="s2">&quot;--ome-zarr-version&quot;</span><span class="p">,</span> <span class="n">ome_zarr_version</span><span class="p">,</span>
        <span class="s2">&quot;--method&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span>
        <span class="s2">&quot;--output-scale&quot;</span><span class="p">,</span> <span class="n">output_scale</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">_run</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="c1"># ---------- C. clean up and return ------------------------------------</span>
    <span class="k">if</span> <span class="n">tmp_tif</span> <span class="ow">and</span> <span class="n">tmp_tif</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">tmp_tif</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">zarr_out</span></div>



<span class="c1"># -------------------------------------------------------------------------</span>
<span class="c1"># 0. build sets for fast membership checks</span>
<span class="c1"># -------------------------------------------------------------------------</span>
<span class="n">modality_lookup</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Imaging formats</span>
    <span class="s2">&quot;.tif&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.czi&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.nd2&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.lsm&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.jpx&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.svs&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.ims&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.png&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.jpg&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.jpeg&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.bmp&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.vsi&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.jp2&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.roi&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.dm3&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.pxp&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.ipf&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.lif&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.ima&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.mrxs&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.obj&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.avi&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.exf&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;.cxd&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.ets&quot;</span><span class="p">:</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">,</span>

    <span class="c1"># Time Series formats</span>
    <span class="s2">&quot;.mat&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.smr&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.adicht&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.h5&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.abf&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.rhd&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.nev&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.ns5&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.ns2&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.ns1&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.smrx&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.wav&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.acq&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.tdx&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.tev&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.tnt&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.tsq&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.eeg&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.vmrk&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.vhdr&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span> <span class="s2">&quot;.sev&quot;</span><span class="p">:</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">,</span>

    <span class="c1"># Documentation formats</span>
    <span class="s2">&quot;.pdf&quot;</span><span class="p">:</span> <span class="s2">&quot;Docs&quot;</span><span class="p">,</span> <span class="s2">&quot;.docx&quot;</span><span class="p">:</span> <span class="s2">&quot;Docs&quot;</span><span class="p">,</span> <span class="s2">&quot;.doc&quot;</span><span class="p">:</span> <span class="s2">&quot;Docs&quot;</span><span class="p">,</span> <span class="s2">&quot;.txt&quot;</span><span class="p">:</span> <span class="s2">&quot;Docs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.xlsx&quot;</span><span class="p">:</span> <span class="s2">&quot;Docs&quot;</span><span class="p">,</span> <span class="s2">&quot;.xls&quot;</span><span class="p">:</span> <span class="s2">&quot;Docs&quot;</span><span class="p">,</span> <span class="s2">&quot;.tsv&quot;</span><span class="p">:</span> <span class="s2">&quot;Docs&quot;</span><span class="p">,</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span> <span class="s2">&quot;Docs&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;.xml&quot;</span><span class="p">:</span> <span class="s2">&quot;Docs&quot;</span><span class="p">,</span> <span class="s2">&quot;.db&quot;</span><span class="p">:</span> <span class="s2">&quot;Docs&quot;</span><span class="p">,</span> <span class="s2">&quot;.xfg&quot;</span><span class="p">:</span> <span class="s2">&quot;Docs&quot;</span><span class="p">,</span>
    
    <span class="c1"># Other formats</span>
    <span class="s2">&quot;.inf&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;.zip&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;(no ext)&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.s2r&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;.ini&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;.cmgui&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.mp4&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;.xlsm&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.db3&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;.ccf&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;.ex&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.conf&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;.rdf&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;.vtk&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;.proj&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;.pnp&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
    <span class="s2">&quot;.hoc&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;.fig	&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span> <span class="s2">&quot;.dat&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span>
<span class="p">}</span>

<span class="n">IMAGING_EXTS</span>     <span class="o">=</span> <span class="p">{</span><span class="n">ext</span> <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">kind</span> <span class="ow">in</span> <span class="n">modality_lookup</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;Imaging&quot;</span><span class="p">}</span>
<span class="n">TIMESERIES_EXTS</span>  <span class="o">=</span> <span class="p">{</span><span class="n">ext</span> <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">kind</span> <span class="ow">in</span> <span class="n">modality_lookup</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;Time Series&quot;</span><span class="p">}</span>
<span class="n">SUPPORTED_EXTS</span>   <span class="o">=</span> <span class="n">IMAGING_EXTS</span> <span class="o">|</span> <span class="n">TIMESERIES_EXTS</span>

<div class="viewcode-block" id="download_and_convert_sparc_data">
<a class="viewcode-back" href="../api.html#sparc_fuse_core.download_and_convert_sparc_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">download_and_convert_sparc_data</span><span class="p">(</span>
    <span class="n">dataset_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">primary_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="s2">&quot;./output&quot;</span><span class="p">,</span>
    <span class="n">descriptors_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="s2">&quot;./mapping_schemes&quot;</span><span class="p">,</span>
    <span class="n">file_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;npz&quot;</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download → convert → clean-up pipeline.</span>

<span class="sd">    Imaging files are routed through `convert_imaging_file`;</span>
<span class="sd">    everything else goes through the descriptor-based mapper.</span>
<span class="sd">    Raw downloads are stored only in a TemporaryDirectory and are</span>
<span class="sd">    deleted as soon as conversion finishes.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        dataset_id (int): The unique identifier of the SPARC dataset to process.</span>
<span class="sd">        primary_paths (list[str] | str | None, optional): List of relative paths to primary files within the dataset.</span>
<span class="sd">            If None, all primary files will be fetched from the dataset metadata.</span>
<span class="sd">        output_dir (str | Path, optional): Directory where converted files will be saved. Defaults to &quot;./output&quot;.</span>
<span class="sd">        descriptors_dir (str | Path, optional): Directory containing mapping descriptors. Defaults to &quot;./mapping_schemes&quot;.</span>
<span class="sd">        file_format (str, optional): Output file format for standardized data. Defaults to &quot;npz&quot;.</span>
<span class="sd">        overwrite (bool, optional): If True, existing standardized files will be overwritten. Defaults to False.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        list[dict]: A list of dictionaries containing the results of the conversion process for each file.</span>
<span class="sd">            Each dictionary includes:</span>
<span class="sd">                - rel_path: Relative path of the file within the dataset.</span>
<span class="sd">                - local_path: Temporary local path where the file was downloaded.</span>
<span class="sd">                - std_path: Path to the standardized output file.</span>
<span class="sd">                - descriptor_id: ID of the mapping descriptor used (if applicable).</span>
<span class="sd">                - mapping_score: Score of the mapping (if applicable).</span>
<span class="sd">                - status: Status of the processing (&quot;ok&quot;, &quot;pending&quot;, &quot;failed&quot;, &quot;unsupported&quot;).</span>
<span class="sd">                - error: Error message if processing failed.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If no primary files are found to process.</span>
<span class="sd">        RuntimeError: If the download fails or the file cannot be processed.</span>
<span class="sd">        FileNotFoundError: If no matching file is found in the dataset for the given relative path.</span>
<span class="sd">        Exception: For any other errors encountered during the download or conversion process.</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">        - The function uses a temporary directory for downloading files, which is automatically cleaned up after processing.</span>
<span class="sd">        - The output directory is created if it does not exist.</span>
<span class="sd">        - Metadata from the SPARC dataset is fetched and included in the standardized output.</span>
<span class="sd">    - The function supports both imaging and time series data, routing them through appropriate conversion methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
    <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># fetch metadata for the dataset</span>
    <span class="n">sparc_meta</span> <span class="o">=</span> <span class="n">fetch_dataset_metadata</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>  <span class="c1"># full JSON dict</span>

    
    <span class="c1"># ---------- A. figure out which primary files to work on --------------</span>
    <span class="k">if</span> <span class="n">primary_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">list_primary_files</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>
        <span class="n">primary_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;files/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">primary_paths</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">primary_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">primary_paths</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">primary_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">primary_paths</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">primary_paths</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No primary files to process.&quot;</span><span class="p">)</span>

    <span class="c1"># ---------- B. load mapping descriptors once --------------------------</span>
    <span class="n">descriptors</span> <span class="o">=</span> <span class="n">load_all_descriptors</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">descriptors_dir</span><span class="p">))</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># ---------- C. main loop ----------------------------------------------</span>
    <span class="k">for</span> <span class="n">rel_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">primary_paths</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Dataset </span><span class="si">{</span><span class="n">dataset_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;rel_path&quot;</span><span class="p">:</span> <span class="n">rel_path</span><span class="p">,</span>
            <span class="s2">&quot;local_path&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>      <span class="c1"># tmp path (will vanish)</span>
            <span class="s2">&quot;std_path&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;descriptor_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;mapping_score&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;pending&quot;</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">ext</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">rel_path</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORTED_EXTS</span><span class="p">:</span>
            <span class="n">rec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;unsupported&quot;</span><span class="p">,</span>
                       <span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Extension &#39;</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&#39; not supported by pipeline&quot;</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
            <span class="k">continue</span>                         <span class="c1"># ── skip to next file ──</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ===== 1. download into a fresh tmp dir =======================</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
                <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rel_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;primary/&quot;</span><span class="p">):</span>
                    <span class="n">rel_path_ds</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;primary/</span><span class="si">{</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rel_path_ds</span> <span class="o">=</span> <span class="n">rel_path</span>
                <span class="n">query_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;files/</span><span class="si">{</span><span class="n">rel_path_ds</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">filename</span>   <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rel_path_ds</span><span class="p">)</span>

                <span class="n">files</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">pennsieve</span><span class="o">.</span><span class="n">list_files</span><span class="p">(</span><span class="n">dataset_id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No matching file for </span><span class="si">{</span><span class="n">query_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Pennsieve will write into the *current* working directory.</span>
                <span class="n">old_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">pennsieve</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">file_list</span><span class="o">=</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>   <span class="c1"># ← no destination_dir</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">old_cwd</span><span class="p">)</span>

                <span class="n">local_file</span> <span class="o">=</span> <span class="n">tmpdir</span> <span class="o">/</span> <span class="n">filename</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">local_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="c1"># Some Pennsieve builds create a sub-folder; fall back to glob search</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                        <span class="n">local_file</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download failed: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">tmpdir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


                <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;local_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">local_file</span><span class="p">)</span>  <span class="c1"># for logging/debug</span>

                <span class="c1"># ===== 2. decide which conversion branch to use ===========</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">local_file</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">IMAGING_EXTS</span><span class="p">:</span>
                    <span class="c1"># ---------- imaging branch ----------------------------</span>
                    <span class="n">zarr_path</span> <span class="o">=</span> <span class="n">convert_imaging_file</span><span class="p">(</span>
                        <span class="n">local_file</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span>
                    <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">root</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zarr_path</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>   <span class="c1"># reopen for attrs</span>
                        <span class="n">root</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;sparc_metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sparc_meta</span>
                        <span class="n">root</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;sparc_dataset_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset_id</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">root</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                    <span class="n">rec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="n">std_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">zarr_path</span><span class="p">),</span>
                        <span class="n">descriptor_id</span><span class="o">=</span><span class="s2">&quot;imaging-pipeline&quot;</span><span class="p">,</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># ---------- signal-mapping branch ----------------------</span>
                    <span class="n">mapping</span> <span class="o">=</span> <span class="n">match_best_mapping</span><span class="p">(</span>
                        <span class="n">descriptors</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">local_file</span><span class="p">),</span> <span class="n">sparc_id</span><span class="o">=</span><span class="n">dataset_id</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;descriptor&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No usable mapping descriptor found&quot;</span><span class="p">)</span>

                    <span class="n">descriptor</span>   <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;descriptor&quot;</span><span class="p">]</span>
                    <span class="n">result_dict</span>  <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span>
                    <span class="n">std_base</span>     <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">local_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_std&quot;</span>

                    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">std_base</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">file_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="n">save_standardized_output</span><span class="p">(</span>
                            <span class="n">output_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">std_base</span><span class="p">),</span>
                            <span class="n">result_dict</span><span class="o">=</span><span class="n">result_dict</span><span class="p">,</span>
                            <span class="n">descriptor</span><span class="o">=</span><span class="n">descriptor</span><span class="p">,</span>
                            <span class="n">original_filename</span><span class="o">=</span><span class="n">local_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">file_format</span><span class="o">=</span><span class="n">file_format</span><span class="p">,</span>
                            <span class="n">metadata_overrides</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sparc_metadata&quot;</span><span class="p">:</span> <span class="n">sparc_meta</span><span class="p">}</span>
                        <span class="p">)</span>

                    <span class="n">rec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="n">std_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">std_base</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">file_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)),</span>
                        <span class="n">descriptor_id</span><span class="o">=</span><span class="n">descriptor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
                        <span class="n">mapping_score</span><span class="o">=</span><span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">],</span>
                        <span class="n">status</span><span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="c1"># tmpdir (and raw download) are deleted automatically here</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">rec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>

        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>


<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">s3fs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>


<div class="viewcode-block" id="upload_to_s3">
<a class="viewcode-back" href="../api.html#sparc_fuse_core.upload_to_s3">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">upload_to_s3</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s2">&quot;eu-north-1&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uploads files from a local directory to an AWS S3 bucket using the AWS CLI.</span>

<span class="sd">    Args:</span>
<span class="sd">        local_path (str): The local directory path to upload.</span>
<span class="sd">        bucket (str): The name of the target S3 bucket.</span>
<span class="sd">        remote_path (str): The destination path within the S3 bucket.</span>
<span class="sd">        region (str, optional): The AWS region where the bucket is located. Defaults to &quot;eu-north-1&quot;.</span>

<span class="sd">    Raises:</span>
<span class="sd">        subprocess.CalledProcessError: If the AWS CLI command fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;AWS_DEFAULT_REGION&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
        <span class="s2">&quot;aws&quot;</span><span class="p">,</span> <span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="s2">&quot;sync&quot;</span><span class="p">,</span>
        <span class="n">local_path</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--region&quot;</span><span class="p">,</span> <span class="n">region</span>
    <span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="consolidate_s3_metadata">
<a class="viewcode-back" href="../api.html#sparc_fuse_core.consolidate_s3_metadata">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">consolidate_s3_metadata</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s2">&quot;eu-north-1&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Consolidates Zarr metadata for a given S3 bucket and remote path.</span>

<span class="sd">    This function connects to an S3 bucket using the specified region, accesses the Zarr store at the given remote path,</span>
<span class="sd">    and consolidates its metadata to improve read performance and compatibility.</span>

<span class="sd">    Args:</span>
<span class="sd">        bucket (str): Name of the S3 bucket containing the Zarr store.</span>
<span class="sd">        remote_path (str): Path within the S3 bucket to the Zarr store.</span>
<span class="sd">        region (str, optional): AWS region where the S3 bucket is located. Defaults to &quot;eu-north-1&quot;.</span>

<span class="sd">    Raises:</span>
<span class="sd">        zarr.errors.PathNotFoundError: If the specified path does not exist in the S3 bucket.</span>
<span class="sd">        botocore.exceptions.BotoCoreError: If there is an error connecting to S3.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;AWS_DEFAULT_REGION&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">client_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;region_name&quot;</span><span class="p">:</span> <span class="n">region</span><span class="p">})</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">FSStore</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">remote_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="c1"># Ensure consolidated metadata exists (idempotent)</span>
    <span class="n">zarr</span><span class="o">.</span><span class="n">consolidate_metadata</span><span class="p">(</span><span class="n">store</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_xarray_zarr_from_raw">
<a class="viewcode-back" href="../api.html#sparc_fuse_core.create_xarray_zarr_from_raw">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_xarray_zarr_from_raw</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">raw_zarr_path</span><span class="p">,</span> <span class="n">xarray_zarr_path</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s2">&quot;eu-north-1&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads raw Zarr data from an S3 bucket, constructs an xarray Dataset, and writes it back to S3 in Zarr format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bucket : str</span>
<span class="sd">        Name of the S3 bucket containing the Zarr data.</span>
<span class="sd">    raw_zarr_path : str</span>
<span class="sd">        Path within the S3 bucket to the raw Zarr store.</span>
<span class="sd">    xarray_zarr_path : str</span>
<span class="sd">        Path within the S3 bucket where the xarray Zarr store will be saved.</span>
<span class="sd">    region : str, optional</span>
<span class="sd">        AWS region name for the S3 bucket (default is &quot;eu-north-1&quot;).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Assumes the raw Zarr store contains &quot;signals&quot; and &quot;time&quot; arrays.</span>
<span class="sd">    - The resulting xarray Dataset will have dimensions (&quot;channel&quot;, &quot;time&quot;), where &quot;channel&quot; is inferred from the shape of &quot;signals&quot;.</span>
<span class="sd">    - Requires `s3fs`, `zarr`, `xarray`, and `numpy` to be installed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;AWS_DEFAULT_REGION&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">client_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;region_name&quot;</span><span class="p">:</span> <span class="n">region</span><span class="p">})</span>

    <span class="c1"># Open raw Zarr, ensuring its consolidated metadata exists</span>
    <span class="n">raw_store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">FSStore</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">raw_zarr_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_consolidated</span><span class="p">(</span><span class="n">raw_store</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># fallback: (re-)consolidate then reopen</span>
        <span class="n">zarr</span><span class="o">.</span><span class="n">consolidate_metadata</span><span class="p">(</span><span class="n">raw_store</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_consolidated</span><span class="p">(</span><span class="n">raw_store</span><span class="p">)</span>

    <span class="c1"># Extract arrays</span>
    <span class="n">signals</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">][:]</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][:]</span>

    <span class="c1"># Build xarray dataset</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;signals&quot;</span><span class="p">:</span> <span class="p">((</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">),</span> <span class="n">signals</span><span class="p">)},</span>
        <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">),</span> <span class="s2">&quot;channel&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;channel&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))},</span>
    <span class="p">)</span>

    <span class="c1"># Copy over original metadata</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>  <span class="c1"># includes .zattrs (sparc_metadata, etc.)</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="s2">&quot;signals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>

    <span class="c1"># Write to S3 and explicitly consolidate</span>
    <span class="n">xarray_store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">FSStore</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">xarray_zarr_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span><span class="n">xarray_store</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">zarr</span><span class="o">.</span><span class="n">consolidate_metadata</span><span class="p">(</span><span class="n">xarray_store</span><span class="p">)</span></div>



<div class="viewcode-block" id="generate_and_upload_manifest">
<a class="viewcode-back" href="../api.html#sparc_fuse_core.generate_and_upload_manifest">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_and_upload_manifest</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">xarray_zarr_path</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s2">&quot;eu-north-1&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a manifest JSON file for a given dataset and uploads it to an S3 bucket.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_id (str): The unique identifier for the dataset.</span>
<span class="sd">        bucket (str): The name of the S3 bucket where the manifest will be uploaded.</span>
<span class="sd">        xarray_zarr_path (str): The path to the Zarr dataset within the S3 bucket.</span>
<span class="sd">        region (str, optional): The AWS region where the S3 bucket is located. Defaults to &quot;eu-north-1&quot;.</span>

<span class="sd">    Raises:</span>
<span class="sd">        subprocess.CalledProcessError: If the AWS CLI command fails during upload.</span>

<span class="sd">    The manifest contains metadata about the dataset, including its ID, Zarr path, generation timestamp, and file format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;AWS_DEFAULT_REGION&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
    <span class="n">manifest</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dataset_id&quot;</span><span class="p">:</span> <span class="n">dataset_id</span><span class="p">,</span>
        <span class="s2">&quot;zarr_path&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">xarray_zarr_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;generated_at&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">Z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;file_format&quot;</span><span class="p">:</span> <span class="s2">&quot;zarr&quot;</span>
    <span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;latest.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span>
        <span class="s2">&quot;aws&quot;</span><span class="p">,</span> <span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="s2">&quot;cp&quot;</span><span class="p">,</span> <span class="s2">&quot;latest.json&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/latest.json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--region&quot;</span><span class="p">,</span> <span class="n">region</span>
    <span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="open_zarr_from_s3">
<a class="viewcode-back" href="../api.html#sparc_fuse_core.open_zarr_from_s3">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">open_zarr_from_s3</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">zarr_path</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s2">&quot;eu-north-1&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lazily open a Zarr dataset stored in an S3 bucket using Xarray.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        bucket (str): Name of the S3 bucket containing the Zarr dataset.</span>
<span class="sd">        zarr_path (str): Path to the Zarr dataset within the S3 bucket.</span>
<span class="sd">        region (str, optional): AWS region where the S3 bucket is located. Defaults to &quot;eu-north-1&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        xarray.Dataset: The opened Zarr dataset as an Xarray Dataset object.</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Requires appropriate AWS credentials to access the S3 bucket.</span>
<span class="sd">        - The function sets the AWS_DEFAULT_REGION environment variable if not already set.</span>
<span class="sd">        - The Zarr dataset must be consolidated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;AWS_DEFAULT_REGION&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
    <span class="n">s3_uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">zarr_path</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">storage_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;client_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;region_name&quot;</span><span class="p">:</span> <span class="n">region</span><span class="p">}}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">s3_uri</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_opts</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">s3_uri</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_opts</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Haberbusch, M et al..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>